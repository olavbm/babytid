<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foreldreveien - Svangerskapskalender for Norge</title>

  <!-- SEO -->
  <meta name="description" content="Gratis svangerskapskalender for Norge. Oversikt over kontroller, NAV-frister, foreldrepermisjon og viktige datoer fra uke 0 til 4 √•r.">
  <meta name="keywords" content="svangerskap, graviditet, svangerskapskontroll, foreldrepermisjon, NAV, termin, Norge, gravid, baby">
  <meta name="author" content="Foreldreveien">
  <link rel="canonical" href="https://olavbm.github.io/babytid/">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://olavbm.github.io/babytid/">
  <meta property="og:title" content="Foreldreveien - Svangerskapskalender for Norge">
  <meta property="og:description" content="Gratis svangerskapskalender med oversikt over kontroller, NAV-frister, foreldrepermisjon og viktige datoer fra uke 0 til 4 √•r.">
  <meta property="og:image" content="https://olavbm.github.io/babytid/og-image.png">
  <meta property="og:locale" content="nb_NO">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://olavbm.github.io/babytid/">
  <meta name="twitter:title" content="Foreldreveien - Svangerskapskalender for Norge">
  <meta name="twitter:description" content="Gratis svangerskapskalender med oversikt over kontroller, NAV-frister, foreldrepermisjon og viktige datoer.">
  <meta name="twitter:image" content="https://olavbm.github.io/babytid/og-image.png">

  <!-- Theme color for mobile browsers -->
  <meta name="theme-color" content="#5a9a9a">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: #faf8f5;
      min-height: 100vh;
      color: #3d3d3d;
      line-height: 1.7;
      font-size: 15px;
    }

    header {
      text-align: center;
      padding: 2rem 1rem;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 8px rgba(0, 0, 0, 0.04);
      transition: padding 0.3s ease;
    }

    header.scrolled {
      padding: 0.75rem 1rem;
    }

    header.scrolled h1,
    header.scrolled > p,
    header.scrolled .legend {
      display: none;
    }

    header.scrolled .date-selector {
      margin-top: 0;
    }

    h1 {
      font-size: 1.8rem;
      font-weight: 600;
      color: #2d5a5a;
      margin-bottom: 0.25rem;
      letter-spacing: -0.5px;
    }

    .date-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .date-selector label {
      font-size: 0.9rem;
      color: #666;
    }

    .date-selector input {
      padding: 0.5rem 0.75rem;
      border: 2px solid #d4e4e4;
      border-radius: 10px;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: #fff;
    }

    .date-selector input:focus {
      border-color: #5a9a9a;
      box-shadow: 0 0 0 3px rgba(90, 154, 154, 0.15);
    }

    .current-week-display {
      background: #5a9a9a;
      color: white;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .timeline {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem 4rem;
      position: relative;
    }

    .timeline::before {
      display: none;
    }

    .timeline-path {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: visible;
      z-index: 0;
    }

    .timeline-path svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: visible;
    }

    .timeline-path path {
      fill: none;
      stroke: url(#pathGradient);
      stroke-width: 4;
      stroke-linecap: round;
      stroke-dasharray: 15 10;
    }

    .timeline-path path.solid {
      stroke: #e8e4df;
      stroke-width: 10;
      stroke-dasharray: none;
      opacity: 0.5;
    }

    .week-card {
      position: relative;
      margin-bottom: 2.5rem;
      opacity: 0.6;
      transform: scale(0.95) translateY(8px);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Winding path effect - smooth S-curves */
    .week-card:nth-child(8n+1) { --sway: -15px; --side: right; }
    .week-card:nth-child(8n+2) { --sway: -45px; --side: right; }
    .week-card:nth-child(8n+3) { --sway: -60px; --side: right; }
    .week-card:nth-child(8n+4) { --sway: -45px; --side: right; }
    .week-card:nth-child(8n+5) { --sway: 15px; --side: left; }
    .week-card:nth-child(8n+6) { --sway: 45px; --side: left; }
    .week-card:nth-child(8n+7) { --sway: 60px; --side: left; }
    .week-card:nth-child(8n+8) { --sway: 45px; --side: left; }

    .week-card.current {
      opacity: 1;
      transform: scale(1) translateY(0);
    }

    .week-card.current .card-content {
      border-color: #5a9a9a;
      box-shadow:
        0 12px 32px rgba(90, 154, 154, 0.25),
        0 0 0 1px rgba(90, 154, 154, 0.1);
      background: linear-gradient(135deg, #fff 0%, #f8fcfc 100%);
    }

    .week-card.past {
      opacity: 0.5;
    }

    .week-marker {
      position: absolute;
      left: calc(50% + var(--sway, 0px));
      transform: translateX(-50%);
      width: 14px;
      height: 14px;
      background: #d9d4ce;
      border-radius: 50%;
      border: 3px solid #fff;
      z-index: 1;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .week-card.current .week-marker {
      background: #5a9a9a;
      width: 18px;
      height: 18px;
      box-shadow:
        0 0 0 6px rgba(90, 154, 154, 0.15),
        0 0 20px rgba(90, 154, 154, 0.3);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow:
          0 0 0 6px rgba(90, 154, 154, 0.15),
          0 0 20px rgba(90, 154, 154, 0.3);
      }
      50% {
        box-shadow:
          0 0 0 10px rgba(90, 154, 154, 0.08),
          0 0 30px rgba(90, 154, 154, 0.4);
      }
    }

    .card-content {
      position: relative;
      z-index: 2;
      background: #fff;
      border-radius: 16px;
      padding: 1.25rem 1.5rem;
      width: calc(50% - 100px);
      border: 1px solid rgba(0, 0, 0, 0.04);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      transition: all 0.3s ease;
      /* Default: card on right when path swings left */
      margin-left: calc(50% + 50px);
    }

    /* When path swings right (positive sway), card goes left */
    .week-card:nth-child(8n+5) .card-content,
    .week-card:nth-child(8n+6) .card-content,
    .week-card:nth-child(8n+7) .card-content,
    .week-card:nth-child(8n+8) .card-content {
      margin-left: 50px;
      margin-right: calc(50%);
    }

    .week-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.35rem;
    }

    .week-number {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #5a9a9a;
      font-weight: 600;
    }

    .week-date {
      font-size: 0.75rem;
      color: #999;
    }

    .week-title {
      font-size: 1.05rem;
      font-weight: 600;
      color: #2d4a4a;
      margin-bottom: 0.75rem;
    }

    .event {
      background: #faf9f7;
      border-radius: 8px;
      padding: 0.7rem 0.9rem;
      margin-bottom: 0.5rem;
      border-left: 3px solid;
    }

    .event:last-child {
      margin-bottom: 0;
    }

    .event[data-source] {
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      position: relative;
    }

    .event[data-source]:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .event[data-source]::after {
      content: "‚Üó";
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      font-size: 0.75rem;
      color: #bbb;
    }

    .event[data-source]:hover::after {
      color: #5a9a9a;
    }

    .event.medical {
      border-color: #d4847a;
      background: #fdf8f7;
    }

    .event.admin {
      border-color: #6a9fb5;
      background: #f6fafb;
    }

    .event.info {
      border-color: #7ab57a;
      background: #f7faf6;
    }

    .event.deadline {
      border-color: #c9a45c;
      background: #fdfbf6;
    }

    .event-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
      color: #3d3d3d;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .event-desc {
      font-size: 0.85rem;
      color: #666;
      line-height: 1.5;
    }

    .event-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.4rem;
      flex-wrap: wrap;
    }

    .event-date {
      font-size: 0.8rem;
      color: #5a9a9a;
      font-weight: 500;
    }

    .trimester-divider {
      text-align: center;
      margin: 2.5rem 0;
      position: relative;
    }

    .trimester-divider span {
      background: #faf8f5;
      padding: 0.5rem 1.25rem;
      font-size: 0.8rem;
      color: #5a9a9a;
      font-weight: 600;
      position: relative;
      z-index: 1;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    /* Birth divider with celebration */
    .birth-divider {
      text-align: center;
      margin: 3rem 0;
      position: relative;
      padding: 2rem 0;
    }

    .birth-divider-content {
      background: linear-gradient(135deg, #fff5f5 0%, #fff0f5 50%, #f5f0ff 100%);
      border: 2px solid #e8b4b8;
      border-radius: 20px;
      padding: 1.5rem 2rem;
      display: inline-block;
      position: relative;
      z-index: 2;
      box-shadow: 0 8px 32px rgba(232, 180, 184, 0.3);
    }

    .birth-divider-emoji {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .birth-divider-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #c46b7a;
      margin-bottom: 0.25rem;
    }

    .birth-divider-subtitle {
      font-size: 0.9rem;
      color: #999;
    }

    /* Confetti animation */
    .confetti-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      opacity: 0;
    }

    .birth-divider:hover .confetti,
    .birth-divider.animate .confetti {
      animation: confetti-fall 3s ease-out forwards;
    }

    @keyframes confetti-fall {
      0% {
        opacity: 1;
        transform: translateY(-20px) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: translateY(150px) rotate(720deg);
      }
    }

    .confetti:nth-child(1) { left: 10%; animation-delay: 0s; background: #ff6b6b; border-radius: 50%; }
    .confetti:nth-child(2) { left: 20%; animation-delay: 0.1s; background: #ffd93d; border-radius: 2px; }
    .confetti:nth-child(3) { left: 30%; animation-delay: 0.2s; background: #6bcb77; border-radius: 50%; }
    .confetti:nth-child(4) { left: 40%; animation-delay: 0.15s; background: #4d96ff; border-radius: 2px; }
    .confetti:nth-child(5) { left: 50%; animation-delay: 0.25s; background: #ff6bb5; border-radius: 50%; }
    .confetti:nth-child(6) { left: 60%; animation-delay: 0.1s; background: #a66cff; border-radius: 2px; }
    .confetti:nth-child(7) { left: 70%; animation-delay: 0.3s; background: #ff9f43; border-radius: 50%; }
    .confetti:nth-child(8) { left: 80%; animation-delay: 0.05s; background: #26de81; border-radius: 2px; }
    .confetti:nth-child(9) { left: 90%; animation-delay: 0.2s; background: #fd79a8; border-radius: 50%; }
    .confetti:nth-child(10) { left: 15%; animation-delay: 0.35s; background: #74b9ff; border-radius: 2px; }
    .confetti:nth-child(11) { left: 25%; animation-delay: 0.4s; background: #ffeaa7; border-radius: 50%; }
    .confetti:nth-child(12) { left: 35%; animation-delay: 0.15s; background: #81ecec; border-radius: 2px; }
    .confetti:nth-child(13) { left: 45%; animation-delay: 0.25s; background: #fab1a0; border-radius: 50%; }
    .confetti:nth-child(14) { left: 55%; animation-delay: 0.3s; background: #a29bfe; border-radius: 2px; }
    .confetti:nth-child(15) { left: 65%; animation-delay: 0.1s; background: #55efc4; border-radius: 50%; }
    .confetti:nth-child(16) { left: 75%; animation-delay: 0.2s; background: #fdcb6e; border-radius: 2px; }
    .confetti:nth-child(17) { left: 85%; animation-delay: 0.35s; background: #e17055; border-radius: 50%; }
    .confetti:nth-child(18) { left: 5%; animation-delay: 0.4s; background: #00b894; border-radius: 2px; }

    /* Post-birth styling */
    .week-card.post-birth .week-number {
      color: #c46b7a;
    }

    .week-card.post-birth.current .card-content {
      border-color: #c46b7a;
      box-shadow:
        0 12px 32px rgba(196, 107, 122, 0.25),
        0 0 0 1px rgba(196, 107, 122, 0.1);
    }

    .week-card.post-birth.current .week-marker {
      background: #c46b7a;
      box-shadow:
        0 0 0 6px rgba(196, 107, 122, 0.15),
        0 0 20px rgba(196, 107, 122, 0.3);
    }

    .event.milestone {
      border-color: #c46b7a;
      background: #fdf8f9;
    }

    .birth-date-input {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(196, 107, 122, 0.2);
    }

    .birth-date-input label {
      display: block;
      font-size: 0.8rem;
      color: #999;
      margin-bottom: 0.3rem;
    }

    .birth-date-input input {
      padding: 0.4rem 0.6rem;
      border: 2px solid #e8b4b8;
      border-radius: 8px;
      font-size: 0.9rem;
      outline: none;
      background: #fff;
    }

    .birth-date-input input:focus {
      border-color: #c46b7a;
      box-shadow: 0 0 0 3px rgba(196, 107, 122, 0.15);
    }

    .status-pregnant {
      background: #5a9a9a;
    }

    .status-born {
      background: #c46b7a;
    }

    .baby-age-display {
      font-size: 0.85rem;
      color: #c46b7a;
      margin-top: 0.25rem;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
      font-size: 0.8rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 3px;
    }

    .legend-dot.medical { background: #d4847a; }
    .legend-dot.admin { background: #6a9fb5; }
    .legend-dot.info { background: #7ab57a; }
    .legend-dot.deadline { background: #c9a45c; }
    .legend-dot.milestone { background: #c46b7a; }

    .oslo-badge {
      background: #e8f4f4;
      color: #2d5a5a;
      font-size: 0.7rem;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      margin-left: 0.5rem;
      font-weight: 500;
    }

    .key-dates {
      max-width: 700px;
      margin: 0 auto;
      padding: 1rem;
    }

    .key-dates-grid {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 0.25rem;
    }

    .key-date-card {
      background: #fff;
      border-radius: 8px;
      padding: 0.6rem 0.8rem;
      border-left: 3px solid;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
      flex-shrink: 0;
      min-width: 120px;
    }

    .key-date-card.termin { border-color: #d4847a; }
    .key-date-card.nav { border-color: #6a9fb5; }
    .key-date-card.arbeidsgiver { border-color: #c9a45c; }
    .key-date-card.barnehage { border-color: #7ab57a; }

    .key-date-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #888;
      margin-bottom: 0.15rem;
    }

    .key-date-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: #2d4a4a;
    }

    .key-date-sub {
      margin-top: 0.2rem;
    }

    .countdown {
      display: inline-block;
      background: #f0f7f7;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      color: #5a9a9a;
      font-weight: 500;
    }

    .countdown.past {
      background: #f5f0f0;
      color: #999;
    }

    .countdown.soon {
      background: #fff3e0;
      color: #c9a45c;
    }

    .event-fixed-date {
      font-size: 0.8rem;
      color: #666;
    }

    @media (max-width: 600px) {
      .week-card {
        --sway: 0px !important;
      }

      .week-card:nth-child(6n+1),
      .week-card:nth-child(6n+2),
      .week-card:nth-child(6n+3),
      .week-card:nth-child(6n+4),
      .week-card:nth-child(6n+5),
      .week-card:nth-child(6n+6) {
        --sway: 0px;
      }

      .week-marker {
        left: 24px !important;
      }

      .card-content,
      .week-card:nth-child(even) .card-content {
        margin-left: 54px !important;
        margin-right: 10px !important;
        width: calc(100% - 64px) !important;
      }

      .timeline-path path {
        stroke-width: 2;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Foreldreveien</h1>
    <p style="color: #7a9a9a; font-size: 0.9rem; font-weight: 400;">Svangerskapskalender for Norge</p>
    <div class="date-selector" id="dateSelector">
      <label for="dueDate" id="dateLabel">Termin:</label>
      <input type="date" id="dueDate">
      <div id="statusDisplay" class="current-week-display"></div>
    </div>
    <div class="legend">
      <div class="legend-item"><span class="legend-dot medical"></span> Helse</div>
      <div class="legend-item"><span class="legend-dot admin"></span> Administrasjon</div>
      <div class="legend-item"><span class="legend-dot info"></span> Informasjon</div>
      <div class="legend-item"><span class="legend-dot deadline"></span> Frist</div>
      <div class="legend-item"><span class="legend-dot milestone"></span> Milep√¶l</div>
    </div>
  </header>

  <div class="key-dates" id="keyDates"></div>
  <div class="timeline" id="timeline"></div>

  <script>
    // State
    let dueDate = null;
    let birthDate = null;

    // DOM elements
    const dueDateInput = document.getElementById('dueDate');
    const statusDisplay = document.getElementById('statusDisplay');
    const timeline = document.getElementById('timeline');
    const keyDatesContainer = document.getElementById('keyDates');

    // Calculate current pregnancy week from due date
    function getCurrentWeek() {
      if (!dueDate) return 0;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const due = new Date(dueDate);
      due.setHours(0, 0, 0, 0);
      const daysUntilDue = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
      const weeksUntilDue = daysUntilDue / 7;
      return Math.round(40 - weeksUntilDue);
    }

    // Calculate the date for a given pregnancy week
    function getDateForWeek(targetWeek) {
      if (!dueDate) return new Date();
      const due = new Date(dueDate);
      const weeksFromDue = 40 - targetWeek;
      return addDays(due, -weeksFromDue * 7);
    }

    // Get due date
    function getDueDate() {
      return dueDate ? new Date(dueDate) : new Date();
    }

    // Get actual birth date or estimated (due date)
    function getActualBirthDate() {
      return birthDate ? new Date(birthDate) : getDueDate();
    }

    // Check if baby is born
    function isBabyBorn() {
      if (birthDate) return true;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const due = getDueDate();
      due.setHours(0, 0, 0, 0);
      return today >= due;
    }

    // Get baby's age in days
    function getBabyAgeDays() {
      const birth = getActualBirthDate();
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      birth.setHours(0, 0, 0, 0);
      return Math.floor((today - birth) / (1000 * 60 * 60 * 24));
    }

    // Format baby age for display
    function formatBabyAge(days) {
      if (days < 0) return null;
      if (days === 0) return "Nyf√∏dt";
      if (days === 1) return "1 dag gammel";
      if (days < 7) return `${days} dager gammel`;
      if (days < 14) return "1 uke gammel";
      if (days < 30) return `${Math.floor(days / 7)} uker gammel`;
      if (days < 60) return "1 m√•ned gammel";
      if (days < 365) return `${Math.round(days / 30)} m√•neder gammel`;
      const years = Math.floor(days / 365);
      const remainingMonths = Math.round((days % 365) / 30);
      if (years === 1 && remainingMonths === 0) return "1 √•r gammel";
      if (remainingMonths === 0) return `${years} √•r gammel`;
      if (years === 1) return `1 √•r og ${remainingMonths} mnd gammel`;
      return `${years} √•r og ${remainingMonths} mnd gammel`;
    }

    // Update status display in header
    function updateStatusDisplay() {
      if (!dueDate) {
        statusDisplay.textContent = '';
        statusDisplay.className = 'current-week-display';
        return;
      }

      if (birthDate || isBabyBorn()) {
        const ageDays = getBabyAgeDays();
        const ageText = formatBabyAge(ageDays);
        if (ageText) {
          statusDisplay.textContent = ageText;
          statusDisplay.className = 'current-week-display status-born';
        }
      } else {
        const week = getCurrentWeek();
        const daysLeft = daysUntil(getDueDate());
        statusDisplay.textContent = `Uke ${week}`;
        statusDisplay.className = 'current-week-display status-pregnant';
      }
    }

    // Format date in Norwegian
    function formatDate(date) {
      const months = ['jan', 'feb', 'mar', 'apr', 'mai', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'des'];
      return `${date.getDate()}. ${months[date.getMonth()]}`;
    }

    function formatDateFull(date) {
      const months = ['januar', 'februar', 'mars', 'april', 'mai', 'juni', 'juli', 'august', 'september', 'oktober', 'november', 'desember'];
      return `${date.getDate()}. ${months[date.getMonth()]} ${date.getFullYear()}`;
    }

    function formatDateWithYear(date) {
      const months = ['jan', 'feb', 'mar', 'apr', 'mai', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'des'];
      return `${date.getDate()}. ${months[date.getMonth()]} ${date.getFullYear()}`;
    }

    function daysUntil(date) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const target = new Date(date);
      target.setHours(0, 0, 0, 0);
      return Math.ceil((target - today) / (1000 * 60 * 60 * 24));
    }

    function getCountdownText(days) {
      if (days < 0) return { text: `${Math.abs(days)} dager siden`, class: 'past' };
      if (days === 0) return { text: 'I dag!', class: 'soon' };
      if (days <= 14) return { text: `om ${days} dager`, class: 'soon' };
      if (days <= 7 * 8) return { text: `om ${Math.ceil(days / 7)} uker`, class: '' };
      return { text: `om ${Math.round(days / 30)} mnd`, class: '' };
    }

    function addDays(date, days) {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    function addWeeks(date, weeks) {
      return addDays(date, weeks * 7);
    }

    function toDateInputValue(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function addMonths(date, months) {
      const result = new Date(date);
      result.setMonth(result.getMonth() + months);
      return result;
    }

    // Get date X days after birth (uses actual birth date if set)
    function getDateAfterBirth(daysAfter) {
      const birth = getActualBirthDate();
      return addDays(birth, daysAfter);
    }

    // Format days after birth as readable text
    function formatPostBirthAge(days) {
      if (days === 0) return "F√∏dsel";
      if (days < 7) return `Dag ${days}`;
      if (days < 30) return `${Math.floor(days / 7)} uke${days >= 14 ? 'r' : ''}`;
      if (days < 365) return `${Math.round(days / 30)} mnd`;
      const years = Math.floor(days / 365);
      const remainingMonths = Math.round((days % 365) / 30);
      if (remainingMonths === 0) return `${years} √•r`;
      return `${years} √•r ${remainingMonths} mnd`;
    }

    // Calculate all key dates
    function getKeyDates() {
      const due = getDueDate();
      const today = new Date();

      // Svangerskapspermisjon can start 3 weeks before due (week 37)
      const permisjonStart = getDateForWeek(37);

      // NAV: S√∏k 4-6 uker f√∏r permisjon starter
      const navS√∏knadAnbefalt = addWeeks(permisjonStart, -5);

      // Employer notification: 12 weeks before for >1 year leave
      const arbeidsgiverVarsel = addWeeks(permisjonStart, -12);

      // Foreldrepenger end (49 weeks at 100% or 59 at 80%)
      const permisjon49Slutt = addWeeks(due, 49);
      const permisjon59Slutt = addWeeks(due, 59);

      // Barnehage
      const birthYear = due.getFullYear();
      const birthMonth = due.getMonth();
      // If born before August, apply by March same year
      // If born August or later, apply by March next year
      let barnehageFristYear = birthMonth < 7 ? birthYear : birthYear + 1;
      const barnehageFrist = new Date(barnehageFristYear, 2, 1);
      const barnehageOppstart = new Date(barnehageFristYear, 7, 15);

      // Baby's 1 year birthday (relevant for permisjon planning)
      const baby1√Ör = addDays(due, 365);

      return {
        due,
        permisjonStart,
        navS√∏knadAnbefalt,
        arbeidsgiverVarsel,
        permisjon49Slutt,
        permisjon59Slutt,
        barnehageFrist,
        barnehageOppstart,
        baby1√Ör
      };
    }

    function renderKeyDates() {
      const dates = getKeyDates();

      const cards = [
        {
          type: 'termin',
          label: 'Termin',
          value: formatDate(dates.due),
          sub: getCountdownText(daysUntil(dates.due))
        },
        {
          type: 'arbeidsgiver',
          label: 'Varsel jobb',
          value: formatDate(dates.arbeidsgiverVarsel),
          sub: getCountdownText(daysUntil(dates.arbeidsgiverVarsel))
        },
        {
          type: 'nav',
          label: 'S√∏k NAV',
          value: formatDate(dates.navS√∏knadAnbefalt),
          sub: getCountdownText(daysUntil(dates.navS√∏knadAnbefalt))
        },
        {
          type: 'barnehage',
          label: 'Barnehage',
          value: formatDate(dates.barnehageFrist),
          sub: getCountdownText(daysUntil(dates.barnehageFrist))
        }
      ];

      keyDatesContainer.innerHTML = `
        <div class="key-dates-grid">
          ${cards.map(card => `
            <div class="key-date-card ${card.type}">
              <div class="key-date-label">${card.label}</div>
              <div class="key-date-value">${card.value}</div>
              <div class="key-date-sub">
                <span class="countdown ${card.sub.class}">${card.sub.text}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Generate weeks data with calculated dates
    function getWeeksData() {
      const dates = getKeyDates();

      return [
        {
          week: 0,
          title: "Befruktning",
          events: [
            { type: "info", title: "Uke 0", desc: "F√∏rste dag av siste menstruasjon. Svangerskapet regnes fra denne datoen." }
          ]
        },
        {
          week: 2,
          title: "Eggl√∏sning og befruktning",
          events: [
            { type: "info", title: "Befruktning skjer", desc: "Eggl√∏sning skjer vanligvis rundt dag 14. Befruktning kan skje i l√∏pet av 12-24 timer." }
          ]
        },
        {
          week: 4,
          title: "Tidlig graviditet",
          events: [
            { type: "info", title: "Positiv test mulig", desc: "Graviditetstest kan vise positivt resultat fra f√∏rste dag med uteblitt mensen" }
          ]
        },
        {
          week: 6,
          title: "F√∏rste kontakt",
          events: [
            { type: "admin", title: "Kontakt fastlege", desc: "Bestill time for bekreftelse av graviditet" },
            { type: "admin", title: "Ring helsestasjonen", desc: "Be om √• bli tildelt jordmor. Du f√•r f√∏rste konsultasjon innen en uke." }
          ]
        },
        {
          week: 8,
          title: "F√∏rste svangerskapskontroll",
          events: [
            { type: "medical", title: "Konsultasjon hos jordmor/lege", desc: "Blodpr√∏ver (hepatitt B, HIV, syfilis, hemoglobin, jernstatus), blodtrykk, urinpr√∏ve, RhD-typing", showDate: true },
            { type: "info", title: "Helsekort", desc: "Du f√•r helsekort for gravide som f√∏lger deg gjennom svangerskapet" }
          ]
        },
        {
          week: 10,
          title: "Fosterdiagnostikk tilbys",
          events: [
            { type: "medical", title: "NIPT-test (valgfritt)", desc: "Blodpr√∏ve for kromosomavvik. Gratis for 35+ √•r, ellers privat ca. 6000-11000 kr", showDate: true, source: "https://www.regjeringen.no/no/aktuelt/fra-januar-vil-gravide-over-35-ar-fa-tilbud-om-nipt/id2885986/" },
            { type: "info", title: "Tidligste tidspunkt", desc: "NIPT kan tas fra uke 10+0. Anbefales uke 10-11 for svar innen uke 12" }
          ]
        },
        {
          week: 11,
          title: "Tidlig ultralyd",
          events: [
            { type: "medical", title: "Ultralyd uke 11-14", desc: "Tilbys alle gravide fra 2022. Kombinert med NIPT ved behov (KUB-test)", showDate: true, source: "https://www.oslo-universitetssykehus.no/behandlinger/tidlig-ultralyd-med-nakketranslusensmaling/" }
          ]
        },
        {
          week: 12,
          trimester: 2,
          title: "Andre trimester begynner",
          events: [
            { type: "info", title: "Lavere risiko", desc: "Risiko for spontanabort reduseres betydelig etter uke 12" },
            { type: "deadline", title: "Informer arbeidsgiver", desc: "Varsle arbeidsgiver senest 12 uker f√∏r for permisjon over 1 √•r", fixedDate: dates.arbeidsgiverVarsel }
          ]
        },
        {
          week: 14,
          title: "Svangerskapskontroll",
          events: [
            { type: "medical", title: "Kontroll hos jordmor", desc: "Oppf√∏lging, vekt, blodtrykk, urinpr√∏ve", showDate: true }
          ]
        },
        {
          week: 17,
          title: "Rutineultralyd n√¶rmer seg",
          events: [
            { type: "admin", title: "Sjekk innkalling", desc: "Du skal ha f√•tt innkalling til rutineultralyd uke 17-19. Kontakt jordmor hvis ikke." }
          ]
        },
        {
          week: 18,
          title: "Rutineultralyd",
          events: [
            { type: "medical", title: "Ultralyd uke 17-19", desc: "Detaljert unders√∏kelse av fosterets organer, morkakeplassering, termin bekreftes", showDate: true, source: "https://www.helsenorge.no/undersokelse-og-behandling/ultralyd-av-gravide/" },
            { type: "info", title: "Kj√∏nn", desc: "Kan ofte sees hvis √∏nskelig" }
          ]
        },
        {
          week: 20,
          title: "Halvveis!",
          events: [
            { type: "info", title: "Fosterbevegelser", desc: "De fleste kjenner tydelige spark og bevegelser n√•" },
            { type: "medical", title: "Svangerskapskontroll", desc: "Regelmessige kontroller hver 4. uke", showDate: true }
          ]
        },
        {
          week: 22,
          title: "Planlegging starter",
          events: [
            { type: "admin", title: "NAV foreldrepenger", desc: "Du kan s√∏ke fra uke 22. Les om rettigheter p√• nav.no/foreldrepenger", fixedDate: dates.navS√∏knadAnbefalt, source: "https://www.nav.no/foreldrepenger" },
            { type: "admin", title: "Velg f√∏dested", desc: "Begynn √• tenke p√• hvor du vil f√∏de. Jordmor sender henvisning." },
            dates.barnehageFrist > new Date() ? {
              type: "deadline",
              title: "Barnehage s√∏knadsfrist",
              desc: "Hovedopptak for barnehageplass med oppstart aug/sept. S√∏k p√• oslo.kommune.no/barnehage",
              location: "Oslo",
              fixedDate: dates.barnehageFrist,
              source: "https://www.oslo.kommune.no/barnehage/soke-barnehageplass/"
            } : null
          ].filter(Boolean)
        },
        {
          week: 24,
          title: "Viktige unders√∏kelser",
          events: [
            { type: "medical", title: "Svangerskapskontroll", desc: "Blodtrykk, symfyse-fundus m√•l, urinpr√∏ve, lytte p√• hjertelyd", showDate: true },
            { type: "medical", title: "Kikhostevaksine", desc: "Anbefales fra uke 24. Gratis. Beskytter barnet frem til 3 mnd alder.", showDate: true, source: "https://www.fhi.no/va/kikhostevaksine-til-gravide/om-innforingen-av-kikhostevaksine-til-gravide/" },
            { type: "medical", title: "RhD-test", desc: "Rhesus-negative: Blodpr√∏ve for √• sjekke fosterets blodtype" },
            { type: "medical", title: "Glukosebelastning", desc: "Tilbys f√∏rstegangs¬≠f√∏dende 25+ eller ved risikofaktorer" }
          ]
        },
        {
          week: 25,
          title: "Foreldrepermisjon",
          events: [
            { type: "admin", title: "Planlegg permisjonen", desc: `Diskuter fordeling med partner. 100%: t.o.m. ${formatDateWithYear(dates.permisjon49Slutt)} (49 uker). 80%: t.o.m. ${formatDateWithYear(dates.permisjon59Slutt)} (59 uker).`, source: "https://www.nav.no/foreldrepenger" },
            { type: "info", title: "Fedrekvote", desc: "15 uker er forbeholdt far/medmor. M√• tas ut, ellers tapes de.", source: "https://www.nav.no/foreldrepenger#hvor-lenge" }
          ]
        },
        {
          week: 28,
          trimester: 3,
          title: "Tredje trimester",
          events: [
            { type: "medical", title: "Svangerskapskontroll", desc: "Kontroller blir hyppigere: hver 2.-4. uke", showDate: true },
            { type: "medical", title: "Anti-D spr√∏yte", desc: "Rhesus-negative med RhD-positivt foster f√•r f√∏rste spr√∏yte n√•" },
            { type: "admin", title: "F√∏dselskurs", desc: "Meld deg p√• kurs. Oslo: ca. 600-1200 kr privat, noen gratis via sykehus" }
          ]
        },
        {
          week: 30,
          title: "Forberedelser",
          events: [
            { type: "admin", title: "Ammekurs", desc: "Vurder kurs. Gratis p√• helsestasjon, eller privat." },
            { type: "info", title: "Babyutstyr", desc: "God tid til √• handle inn n√∏dvendig utstyr" }
          ]
        },
        {
          week: 32,
          title: "Svangerskapskontroll",
          events: [
            { type: "medical", title: "Kontroll hos jordmor", desc: "Fosterstilling, vekst, trivsel, blodtrykk", showDate: true },
            { type: "admin", title: "Kontakt f√∏deavdeling", desc: "F√• omvisning og informasjon om f√∏dested" }
          ]
        },
        {
          week: 34,
          title: "Siste forberedelser",
          events: [
            { type: "admin", title: "Pakk f√∏debag", desc: "Ha klar bag med det du trenger til f√∏de- og barselavdeling" },
            { type: "deadline", title: "S√∏k foreldrepenger N√Ö", desc: `NAV anbefaler √• s√∏ke 4-6 uker f√∏r. Frist: senest 3 mnd etter f√∏dsel.`, showDate: true },
            { type: "info", title: "Fosterstilling", desc: "De fleste babyer snur seg hodeleie n√•. Seteleie? Snakk med jordmor." }
          ]
        },
        {
          week: 36,
          title: "Hyppige kontroller",
          events: [
            { type: "medical", title: "Kontroll", desc: "Ukentlige eller annenhver uke kontroller starter", showDate: true },
            { type: "medical", title: "Posisjon sjekkes", desc: "Bekrefter hodeleie. Seteleie kan kreve spesialistvurdering." },
            { type: "medical", title: "Anti-D #2", desc: "Rhesus-negative: Andre spr√∏yte gis n√•" },
            { type: "info", title: "GBS", desc: "Norge screener ikke rutinemessig, men test kan gj√∏res ved risiko" }
          ]
        },
        {
          week: 37,
          title: "Fullb√•rent - permisjon kan starte",
          events: [
            { type: "info", title: "Barnet er klart", desc: "Regnes som fullb√•rent fra uke 37. Trygt √• f√∏de fra n√•.", source: "https://www.helsenorge.no/fodsel/fodselens-faser/" },
            { type: "admin", title: "Svangerskapspermisjon", desc: "3 uker f√∏r termin er forbeholdt mor. Du kan starte permisjonen fra n√•.", fixedDate: dates.permisjonStart, source: "https://www.nav.no/foreldrepenger#for-fodsel" }
          ]
        },
        {
          week: 38,
          title: "Vent p√• tegn",
          events: [
            { type: "medical", title: "Svangerskapskontroll", desc: "Tett oppf√∏lging. Ring f√∏deavdeling ved vannavgang eller regelmessige rier.", showDate: true },
            { type: "info", title: "Tegn p√• f√∏dsel", desc: "Slimplugg, uregelmessige rier, lavere magetoppunkt, √∏kt trykk nedover" }
          ]
        },
        {
          week: 39,
          title: "Nesten der",
          events: [
            { type: "medical", title: "Kontroll", desc: "Fortsatt oppf√∏lging av blodtrykk, fosterlyd, bevegelser", showDate: true },
            { type: "info", title: "Hvil", desc: "Ta det med ro. Sov og hvil n√•r du kan." }
          ]
        },
        {
          week: 40,
          title: "Termin!",
          events: [
            { type: "deadline", title: "Termindato", desc: "Bare ca. 5% f√∏der p√• selve termindatoen. Normalt √• f√∏de uke 37-42.", fixedDate: dates.due },
            { type: "medical", title: "Overtidskontroll", desc: "Ved termin+0 starter tettere oppf√∏lging med kontroll hver 2-3 dag" }
          ]
        },
        {
          week: 41,
          title: "Over termin",
          events: [
            { type: "medical", title: "Hyppige kontroller", desc: "CTG (hjerteoverv√•kning), ultralyd for fostervann, generell vurdering", showDate: true },
            { type: "medical", title: "Igangsetting vurderes", desc: "Diskusjon om induksjon. Vanlig √• sette i gang f√∏r uke 42." }
          ]
        },
        {
          week: 42,
          title: "Igangsetting",
          events: [
            { type: "medical", title: "Induksjon", desc: "F√∏dselen settes vanligvis i gang innen uke 42+0 i Norge", showDate: true }
          ]
        },
        // === F√òDSEL === (special marker)
        { isBirth: true },
        // Post-birth timeline (daysAfterBirth)
        {
          postBirth: true,
          daysAfterBirth: 0,
          title: "Babyen er her!",
          events: [
            { type: "milestone", title: "Gratulerer!", desc: "Nyt de f√∏rste √∏yeblikkene med den nye verdensborger." },
            { type: "medical", title: "Barselopphold", desc: "1-3 dager p√• sykehus. Ammestart, h√∏rseltest, blodpr√∏ve (nyf√∏dtscreening)." },
            { type: "admin", title: "F√∏dselsmelding sendes", desc: "Jordmor/lege sender melding til Skatteetaten. Barnet registreres i Folkeregisteret." }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 7,
          title: "F√∏rste uke hjemme",
          events: [
            { type: "medical", title: "Hjemmebes√∏k fra jordmor", desc: "Innen 1-3 dager etter hjemkomst. Sjekker amming, navle, vekt og trivsel." },
            { type: "medical", title: "Hjemmebes√∏k helsestasjon", desc: "Dag 7-10: Helsesykepleier kommer hjem. Veiing, m√•ling, samtale om den nye hverdagen." },
            { type: "admin", title: "Barnetrygd", desc: "Innvilges automatisk innen 2 m√•neder. Du trenger ikke s√∏ke." }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 28,
          title: "4 uker",
          events: [
            { type: "medical", title: "Kontroll p√• helsestasjon", desc: "Vekt, lengde, hodeomkrets. Samtale om amming, s√∏vn og foreldrerollen." }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 42,
          title: "6 uker - stor kontroll",
          events: [
            { type: "medical", title: "6-ukerskontroll", desc: "Grundig unders√∏kelse av baby hos lege: reflekser, hofter, √∏yne, √∏rer, hud.", source: "https://www.helsenorge.no/hjelpetilbud-i-kommunene/helsestasjon-0-5-ar/6-ukerskontroll/" },
            { type: "medical", title: "F√∏rste vaksine!", desc: "Rotavirus (dr√•per), DTP-IPV-Hib-HepB (6-i-1), Pneumokokk.", source: "https://www.fhi.no/va/barnevaksinasjonsprogrammet/" },
            { type: "medical", title: "Barselkontroll for mor", desc: "Sjekk av hvordan kroppen har kommet seg etter f√∏dselen." },
            { type: "admin", title: "Foreldrepenger", desc: "Aktivitetskrav for mor starter n√• (10 ukers fritak for barn f√∏dt etter 2. aug 2024)." }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 90,
          title: "3 m√•neder",
          events: [
            { type: "medical", title: "Helsestasjonskontroll", desc: "Vekst, utvikling, samspill mellom foreldre og barn." },
            { type: "medical", title: "Vaksiner dose 2", desc: "Rotavirus, DTP-IPV-Hib-HepB, Pneumokokk.", source: "https://www.fhi.no/va/barnevaksinasjonsprogrammet/" }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 120,
          title: "4 m√•neder",
          events: [
            { type: "medical", title: "Helsestasjonskontroll", desc: "Oppf√∏lging av vekst og utvikling." }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 150,
          title: "5 m√•neder",
          events: [
            { type: "medical", title: "Vaksiner dose 3", desc: "DTP-IPV-Hib-HepB, Pneumokokk (siste rotavirus var ved 3 mnd).", source: "https://www.fhi.no/va/barnevaksinasjonsprogrammet/" }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 180,
          title: "6 m√•neder",
          events: [
            { type: "medical", title: "Helsestasjonskontroll", desc: "Halv√•rskontroll: syn, h√∏rsel, motorikk, sosial utvikling." },
            { type: "deadline", title: "Frist: Registrer barnets navn", desc: "Barnets navn m√• meldes til Skatteetaten innen 6 m√•neder etter f√∏dsel.", source: "https://www.skatteetaten.no/person/folkeregister/fodsel-og-navnevalg/navnevalg/" },
            { type: "info", title: "Fast f√∏de", desc: "Mange starter med smakspr√∏ver og gr√∏t n√•." }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 240,
          title: "8 m√•neder",
          events: [
            { type: "medical", title: "Helsestasjonskontroll", desc: "Oppf√∏lging av motorisk utvikling, kommunikasjon." }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 300,
          title: "10 m√•neder",
          events: [
            { type: "medical", title: "Helsestasjonskontroll", desc: "Vurdering av utvikling, ern√¶ring, s√∏vn." }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 365,
          title: "1 √•r! üéÇ",
          events: [
            { type: "milestone", title: "Gratulerer med ett√•rsdagen!", desc: "Et helt √•r som foreldre!" },
            { type: "medical", title: "12-m√•nederskontroll", desc: "Stor kontroll med lege. Vekst, utvikling, syn, h√∏rsel." },
            { type: "medical", title: "Vaksiner dose 4", desc: "DTP-IPV-Hib-HepB, Pneumokokk (siste dose av disse).", source: "https://www.fhi.no/va/barnevaksinasjonsprogrammet/" },
            { type: "admin", title: "Kontantst√∏tte", desc: "Kan s√∏kes for barn 1-2 √•r som ikke g√•r i barnehage med offentlig st√∏tte." },
            { type: "info", title: "Foreldrepermisjon 100%", desc: "Ved 100% dekningsgrad: Permisjonen n√¶rmer seg slutten (49 uker)." }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 456,
          title: "15 m√•neder",
          events: [
            { type: "medical", title: "MMR-vaksine", desc: "Vaksine mot meslinger, kusma og r√∏de hunder.", source: "https://www.fhi.no/va/barnevaksinasjonsprogrammet/" },
            { type: "medical", title: "Helsestasjonskontroll", desc: "Utvikling, spr√•k, motorikk." }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 540,
          title: "17-18 m√•neder",
          events: [
            { type: "medical", title: "Helsestasjonskontroll", desc: "Spr√•kutvikling, sosial utvikling, gangfunksjon." }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 730,
          title: "2 √•r",
          events: [
            { type: "medical", title: "2-√•rskontroll", desc: "Spr√•k, motorikk, sosial utvikling. Siste rutinemessige kontroll f√∏r 4 √•r." },
            { type: "admin", title: "Kontantst√∏tte slutter", desc: "Kontantst√∏tte gis kun til barn mellom 1-2 √•r." }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 1095,
          title: "3 √•r",
          events: [
            { type: "deadline", title: "Frist: Bruk opp foreldrepenger", desc: "Alle foreldrepenger m√• v√¶re tatt ut f√∏r barnet fyller 3 √•r.", source: "https://www.nav.no/foreldrepenger#hvor-lenge" }
          ]
        },
        {
          postBirth: true,
          daysAfterBirth: 1460,
          title: "4 √•r",
          events: [
            { type: "medical", title: "4-√•rskontroll", desc: "Stor helseunders√∏kelse: syn, h√∏rsel, spr√•k, motorikk, sosial utvikling. Siste f√∏r skolestart." }
          ]
        }
      ];
    }

    function renderTimeline() {
      timeline.innerHTML = '<div class="timeline-path"><svg></svg></div>';
      let lastTrimester = 1;
      const weeks = getWeeksData();
      const dates = getKeyDates();

      weeks.forEach((weekData, index) => {
        // Handle birth divider
        if (weekData.isBirth) {
          const birthDivider = document.createElement('div');
          birthDivider.className = 'birth-divider';
          const birthDateValue = birthDate ? toDateInputValue(birthDate) : '';
          const displayDate = birthDate ? formatDateFull(birthDate) : `Termin: ${formatDateFull(dates.due)}`;

          birthDivider.innerHTML = `
            <div class="confetti-container">
              ${Array.from({length: 18}, (_, i) => `<div class="confetti"></div>`).join('')}
            </div>
            <div class="birth-divider-content">
              <div class="birth-divider-emoji">üë∂</div>
              <div class="birth-divider-title">${birthDate ? 'F√∏dt!' : 'F√∏dsel'}</div>
              <div class="birth-divider-subtitle">${displayDate}</div>
              <div class="birth-date-input">
                <label for="birthDate">${birthDate ? 'F√∏dselsdato:' : 'Registrer f√∏dselsdato:'}</label>
                <input type="date" id="birthDateInput" value="${birthDateValue}">
              </div>
            </div>
          `;

          // Add event listener for birth date input
          const birthInput = birthDivider.querySelector('#birthDateInput');
          birthInput.addEventListener('change', (e) => {
            if (e.target.value) {
              birthDate = new Date(e.target.value + 'T00:00:00');
              localStorage.setItem('babytid_birthDate', e.target.value);
            } else {
              birthDate = null;
              localStorage.removeItem('babytid_birthDate');
            }
            updateStatusDisplay();
            renderTimeline();
            renderKeyDates();
            requestAnimationFrame(drawTimelinePath);
          });

          // Trigger confetti on scroll into view
          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                birthDivider.classList.add('animate');
              }
            });
          }, { threshold: 0.5 });
          observer.observe(birthDivider);
          timeline.appendChild(birthDivider);
          return;
        }

        // Handle trimester dividers
        if (weekData.trimester && weekData.trimester !== lastTrimester) {
          const divider = document.createElement('div');
          divider.className = 'trimester-divider';
          divider.innerHTML = `<span>${weekData.trimester}. trimester</span>`;
          timeline.appendChild(divider);
          lastTrimester = weekData.trimester;
        }

        const card = document.createElement('div');
        card.className = 'week-card';

        // Handle post-birth cards
        if (weekData.postBirth) {
          card.classList.add('post-birth');
          const postBirthDate = getDateAfterBirth(weekData.daysAfterBirth);
          const daysPast = daysUntil(postBirthDate);

          if (daysPast <= 0 && daysPast > -30) {
            card.classList.add('current');
          } else if (daysPast > 0) {
            // Future post-birth event
          } else {
            card.classList.add('past');
          }

          const ageLabel = formatPostBirthAge(weekData.daysAfterBirth);
          const weekDateStr = formatDateWithYear(postBirthDate);

          card.innerHTML = `
            <div class="week-marker"></div>
            <div class="card-content">
              <div class="week-header">
                <div class="week-number">${ageLabel}</div>
                <div class="week-date">${weekDateStr}</div>
              </div>
              <div class="week-title">${weekData.title}</div>
              ${weekData.events.map(event => {
                const locationBadge = event.location ? `<span class="oslo-badge">${event.location}</span>` : '';

                let metaHtml = '';
                const days = daysUntil(postBirthDate);
                const countdown = getCountdownText(days);
                if (days !== 0) {
                  metaHtml = `
                    <div class="event-meta">
                      <span class="countdown ${countdown.class}">${countdown.text}</span>
                    </div>`;
                }

                const sourceAttr = event.source ? `data-source="${event.source}"` : '';
                return `
                  <div class="event ${event.type}" ${sourceAttr}>
                    <div class="event-title">${event.title}${locationBadge}</div>
                    <div class="event-desc">${event.desc}</div>
                    ${metaHtml}
                  </div>
                `;
              }).join('')}
            </div>
          `;

          timeline.appendChild(card);
          return;
        }

        // Regular pregnancy week cards
        const currentWeekNum = getCurrentWeek();
        if (weekData.week === currentWeekNum) {
          card.classList.add('current');
        } else if (weekData.week < currentWeekNum) {
          card.classList.add('past');
        }

        const weekDate = getDateForWeek(weekData.week);
        const weekDateStr = formatDateWithYear(weekDate);

        card.innerHTML = `
          <div class="week-marker"></div>
          <div class="card-content">
            <div class="week-header">
              <div class="week-number">Uke ${weekData.week}</div>
              <div class="week-date">${weekDateStr}</div>
            </div>
            <div class="week-title">${weekData.title}</div>
            ${weekData.events.map(event => {
              const locationBadge = event.location ? `<span class="oslo-badge">${event.location}</span>` : '';

              let metaHtml = '';
              if (event.fixedDate) {
                const days = daysUntil(event.fixedDate);
                const countdown = getCountdownText(days);
                metaHtml = `
                  <div class="event-meta">
                    <span class="event-fixed-date">${formatDateWithYear(event.fixedDate)}</span>
                    <span class="countdown ${countdown.class}">${countdown.text}</span>
                  </div>`;
              } else if (event.showDate) {
                const eventDate = getDateForWeek(weekData.week);
                const days = daysUntil(eventDate);
                const countdown = getCountdownText(days);
                if (days !== 0) {
                  metaHtml = `
                    <div class="event-meta">
                      <span class="countdown ${countdown.class}">${countdown.text}</span>
                    </div>`;
                }
              }

              const sourceAttr = event.source ? `data-source="${event.source}"` : '';
              return `
                <div class="event ${event.type}" ${sourceAttr}>
                  <div class="event-title">${event.title}${locationBadge}</div>
                  <div class="event-desc">${event.desc}</div>
                  ${metaHtml}
                </div>
              `;
            }).join('')}
          </div>
        `;

        timeline.appendChild(card);
      });
    }

    function drawTimelinePath() {
      const svg = document.querySelector('.timeline-path svg');
      if (!svg) return;

      const markers = document.querySelectorAll('.week-card .week-marker');
      if (markers.length < 2) return;

      const timelineRect = timeline.getBoundingClientRect();
      const points = [];

      markers.forEach(marker => {
        const rect = marker.getBoundingClientRect();
        points.push({
          x: rect.left - timelineRect.left + rect.width / 2,
          y: rect.top - timelineRect.top + rect.height / 2
        });
      });

      // Build smooth curve path
      let d = `M ${points[0].x} ${points[0].y}`;

      for (let i = 1; i < points.length; i++) {
        const prev = points[i - 1];
        const curr = points[i];
        const midY = (prev.y + curr.y) / 2;

        // Use cubic bezier for smooth S-curves
        d += ` C ${prev.x} ${midY}, ${curr.x} ${midY}, ${curr.x} ${curr.y}`;
      }

      svg.innerHTML = `
        <defs>
          <linearGradient id="pathGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#5a9a9a" stop-opacity="0.3" />
            <stop offset="40%" stop-color="#d9d4ce" />
            <stop offset="60%" stop-color="#e8b4b8" />
            <stop offset="100%" stop-color="#c46b7a" stop-opacity="0.3" />
          </linearGradient>
        </defs>
        <path class="solid" d="${d}" />
        <path d="${d}" />
      `;
      svg.style.height = timeline.scrollHeight + 'px';
    }

    function scrollToCurrentWeek() {
      const currentCard = document.querySelector('.week-card.current');
      if (currentCard) {
        isUserScrolling = false;
        setTimeout(() => {
          currentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => { isUserScrolling = true; }, 500);
        }, 100);
      }
    }

    function updateFromDueDate() {
      const value = dueDateInput.value;
      if (value) {
        dueDate = new Date(value + 'T00:00:00');
        localStorage.setItem('babytid_dueDate', value);
      } else {
        dueDate = null;
        localStorage.removeItem('babytid_dueDate');
      }
      updateStatusDisplay();
      renderKeyDates();
      renderTimeline();
      setTimeout(() => {
        drawTimelinePath();
        scrollToCurrentWeek();
      }, 50);
    }

    // Load saved dates
    const savedDueDate = localStorage.getItem('babytid_dueDate');
    if (savedDueDate) {
      dueDate = new Date(savedDueDate + 'T00:00:00');
      dueDateInput.value = savedDueDate;
    }

    const savedBirthDate = localStorage.getItem('babytid_birthDate');
    if (savedBirthDate) {
      birthDate = new Date(savedBirthDate + 'T00:00:00');
    }

    dueDateInput.addEventListener('change', updateFromDueDate);

    const header = document.querySelector('header');
    let isUserScrolling = true;

    updateStatusDisplay();
    renderKeyDates();
    renderTimeline();
    // Wait for layout to stabilize before drawing path
    setTimeout(() => {
      drawTimelinePath();
      scrollToCurrentWeek();
    }, 100);

    // Redraw path on window resize
    window.addEventListener('resize', () => {
      requestAnimationFrame(drawTimelinePath);
    });

    // Handle clicks on events with sources
    document.addEventListener('click', (e) => {
      const event = e.target.closest('.event[data-source]');
      if (event) {
        window.open(event.dataset.source, '_blank', 'noopener');
      }
    });

    window.addEventListener('scroll', () => {
      header.classList.toggle('scrolled', window.scrollY > 50);

      // Update active card based on scroll position
      if (isUserScrolling) {
        const cards = document.querySelectorAll('.week-card');
        const headerHeight = header.offsetHeight;
        const viewportCenter = window.scrollY + headerHeight + (window.innerHeight - headerHeight) / 3;

        let closestCard = null;
        let closestDistance = Infinity;

        cards.forEach(card => {
          const rect = card.getBoundingClientRect();
          const cardTop = window.scrollY + rect.top;
          const distance = Math.abs(cardTop - viewportCenter);

          if (distance < closestDistance) {
            closestDistance = distance;
            closestCard = card;
          }
        });

        if (closestCard) {
          // Remove current from all cards and add to closest
          cards.forEach(c => c.classList.remove('current'));
          closestCard.classList.add('current');

          // Update status display and label based on whether we're in post-birth section
          const isPostBirth = closestCard.classList.contains('post-birth');
          const weekLabel = closestCard.querySelector('.week-number');
          const dateLabel = document.getElementById('dateLabel');

          if (isPostBirth && weekLabel) {
            // Show baby's age from the card
            statusDisplay.textContent = weekLabel.textContent;
            statusDisplay.className = 'current-week-display status-born';
            // Change label and show birth date
            dateLabel.textContent = 'F√∏dt:';
            if (birthDate) {
              dueDateInput.value = toDateInputValue(birthDate);
            }
          } else if (weekLabel && dueDate) {
            // Show pregnancy week
            const weekMatch = weekLabel.textContent.match(/Uke (\d+)/);
            if (weekMatch) {
              statusDisplay.textContent = `Uke ${weekMatch[1]}`;
              statusDisplay.className = 'current-week-display status-pregnant';
            }
            // Change label back and show due date
            dateLabel.textContent = 'Termin:';
            dueDateInput.value = toDateInputValue(dueDate);
          }
        }
      }
    });
  </script>
</body>
</html>
